<!doctype html>
<meta charset="UTF-8" />
<title>Digital Book of Centuries</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="format-detection" content="telephone=no" />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Open+Sans:700,400,300"
/>
<link rel="stylesheet" href="print.css" media="print" />
<style>
    body {
        font-family:
            Open Sans,
            Helvetica,
            Arial,
            sans-serif;
        color: #fff;
        background-color: #404040;
        margin: 0;
        padding: 0;
        font-size: 12px;
        -webkit-text-size-adjust: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        cursor: default;
    }
    a {
        color: #fff;
    }
    header {
        z-index: 3;
        background: linear-gradient(
            to bottom,
            rgba(56, 64, 71, 0) 0%,
            rgba(56, 64, 71, 0.5) 20%,
            rgba(56, 64, 71, 1) 50%,
            rgba(56, 64, 71, 0.5) 80%,
            rgba(56, 64, 71, 0) 100%
        );
        position: fixed;
        bottom: 0;
        left: 0;
        margin: 0;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    header #controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    header select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        min-width: 150px;
    }
    header select option {
        background: #404040;
        color: #fff;
    }
    header input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        min-width: 200px;
    }
    header input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    header button {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 5px 15px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.2s;
    }
    header button:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    header a {
        margin-left: 1em;
        opacity: 0.3;
        text-decoration: none;
    }
    header a:hover {
        opacity: 0.7;
        text-decoration: underline;
    }
    .selected-event {
        background-color: rgba(255, 255, 0, 0.3) !important;
        border: 2px solid #ffff00 !important;
        border-radius: 4px;
    }
    .related-event {
        background-color: rgba(0, 255, 255, 0.2) !important;
        border: 1px solid #00ffff !important;
        border-radius: 3px;
    }
    .event {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .event:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    /* Mobile and tablet optimizations */
    @media (max-width: 768px) {
        body {
            font-size: 10px;
        }
        
        header {
            position: relative;
            background: rgba(56, 64, 71, 1);
            padding: 5px;
            margin-bottom: 10px;
        }
        
        header h1 {
            font-size: 16px;
            margin-bottom: 10px;
            display: block;
            text-align: center;
        }
        
        header #controls {
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        header select, header input, header button {
            min-width: auto;
            width: 100%;
            font-size: 11px;
            padding: 8px;
        }
        
        header select[multiple] {
            min-height: 80px;
        }
        
        header a {
            text-align: center;
            margin: 10px 0 0 0;
        }
        
        .event {
            font-size: 9px;
            line-height: 1.2;
            margin-bottom: 2px;
            padding: 2px;
            border-radius: 3px;
        }
        
        .event b {
            display: block;
            margin-bottom: 2px;
        }
        
        #life-years {
            font-size: 8px;
        }
        
        #life-years .year {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            height: 40px;
            line-height: 1;
        }
    }
    
    @media (max-width: 480px) {
        body {
            font-size: 9px;
        }
        
        header h1 {
            font-size: 14px;
        }
        
        .event {
            font-size: 8px;
        }
        
        #life-years .year {
            height: 30px;
            font-size: 7px;
        }
    }
    
    /* Touch interaction improvements */
    @media (hover: none) and (pointer: coarse) {
        .event {
            padding: 6px;
            margin-bottom: 4px;
            min-height: 20px;
        }
        
        .event:active {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(0.98);
        }
        
        header select, header input, header button {
            min-height: 44px; /* iOS recommended touch target size */
        }
    }
    h1 {
        display: inline;
        font-size: 20px;
        line-height: 1em;
        opacity: 0.5;
        z-index: 3;
        font-weight: 300;
        white-space: nowrap;
    }
    code.worldhistory {
        color: #fef08a;
    }
    code.wars {
        color: #fca5a5;
    }
    code.politics {
        color: #a7f3d0;
    }
    code.rulers {
        color: #ddd6fe;
    }
    code.discoveries {
        color: #a5f3fc;
    }
    code.disasters {
        color: #fda4af;
    }
    code.construction {
        color: #c4b5fd;
    }
    #life {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        cursor: -webkit-grab;
        cursor: -moz-grab;
        cursor: grab;
    }
    #life-years {
        position: absolute;
        top: 0;
        bottom: 0;
        white-space: nowrap;
        pointer-events: none;
    }
    #life-years .year {
        display: inline-block;
        box-sizing: border-box;
        color: #fff;
        font-weight: 300;
        white-space: nowrap;
        box-sizing: border-box;
        height: 100%;
        border-left: 1px dashed rgba(255, 255, 255, 0.2);
    }
    #life-years .year.decade {
        border-left: 2px solid rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.05);
    }
    #life-years .year.decade span {
        font-weight: 400;
        font-size: 13px;
    }
    #life-years .year:first-child {
        border-left: 0;
    }
    #life-years .year span {
        background: linear-gradient(
            to bottom,
            rgba(56, 64, 71, 1) 30%,
            rgba(56, 64, 71, 0) 100%
        );
        display: block;
        padding: 10px;
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 3;
    }
    #life-years .year span i {
        opacity: 0.5;
        font-style: normal;
    }
    #life-events {
        padding-top: 40px;
        padding-bottom: 5em;
        position: relative;
    }
    #life-events:after {
        content: "";
        display: block;
        clear: left;
    }
    #life .event {
        padding-right: 20px;
        padding-bottom: 5px;
        vertical-align: middle;
        white-space: nowrap;
        float: left;
        clear: left;
    }
    #life .event b {
        font-weight: normal;
        color: rgba(255, 255, 255, 0.5);
    }
    #life .event .time {
        display: inline-block;
        overflow: hidden;
        height: 0;
        border: 4px solid #fff;
        border-radius: 4px;
        margin-right: 10px;
        opacity: 0.3;
        position: relative;
        left: -2px;
    }
    #life .event:hover .time {
        opacity: 0.5;
    }
</style>
<header>
    <h1 id="title">Digital Book of Centuries</h1>
    <div id="controls">
        <input type="text" id="search-input" placeholder="Search events..." />
        <select id="century-selector">
            <option value="">All Centuries (1-2000 AD)</option>
            <option value="1">Century 1 (1-100 AD)</option>
            <option value="2">Century 2 (101-200 AD)</option>
            <option value="3">Century 3 (201-300 AD)</option>
            <option value="4">Century 4 (301-400 AD)</option>
            <option value="5">Century 5 (401-500 AD)</option>
            <option value="6">Century 6 (501-600 AD)</option>
            <option value="7">Century 7 (601-700 AD)</option>
            <option value="8">Century 8 (701-800 AD)</option>
            <option value="9">Century 9 (801-900 AD)</option>
            <option value="10">Century 10 (901-1000 AD)</option>
            <option value="11">Century 11 (1001-1100 AD)</option>
            <option value="12">Century 12 (1101-1200 AD)</option>
            <option value="13">Century 13 (1201-1300 AD)</option>
            <option value="14">Century 14 (1301-1400 AD)</option>
            <option value="15">Century 15 (1401-1500 AD)</option>
            <option value="16">Century 16 (1501-1600 AD)</option>
            <option value="17">Century 17 (1601-1700 AD)</option>
            <option value="18">Century 18 (1701-1800 AD)</option>
            <option value="19">Century 19 (1801-1900 AD)</option>
            <option value="20">Century 20 (1901-2000 AD)</option>
        </select>
        <select id="child-selector">
            <option value="">All Family Events</option>
            <option value="najmi">Najmi's Book</option>
            <option value="isa">Isa's Book</option>
            <option value="nada">Nada's Book</option>
        </select>
        <select id="category-selector" multiple>
            <option value="">All Categories</option>
            <option value="worldhistory">World History</option>
            <option value="wars">Wars</option>
            <option value="politics">Politics</option>
            <option value="rulers">Rulers</option>
            <option value="discoveries">Discoveries</option>
            <option value="disasters">Disasters</option>
            <option value="construction">Construction</option>
        </select>
        <button id="clear-filters-btn">Clear All Filters</button>
        <button id="export-json-btn">Export JSON</button>
        <button id="export-csv-btn">Export CSV</button>
        <button id="print-btn" onclick="window.preparePrint()">Print Century</button>
    </div>
    <a href="https://github.com/zainfathoni/book-of-centuries">View on GitHub</a>
</header>
<div id="life"></div>
<script>
    (function () {
        var life = {
            $title: document.getElementById("title"),
            $el: document.getElementById("life"),
            utils: {
                extend: function (object) {
                    var args = Array.prototype.slice.call(arguments, 1);
                    for (var i = 0, source; (source = args[i]); i++) {
                        if (!source) continue;
                        for (var property in source) {
                            object[property] = source[property];
                        }
                    }
                    return object;
                },
            },
            config: {
                yearLength: 120, // 120px per year
                hideAge: false, // Hide age from year axis
                customStylesheetURL: null, // Custom stylesheet
            },
            start: function () {
                life.loadConfig(function (config) {
                    life.config = life.utils.extend(life.config, config);
                    if (life.config.customStylesheetURL)
                        life.injectStylesheet(life.config.customStylesheetURL);

                    life.fetch(function (response) {
                        var data = life.parse(response);
                        var title = life.parseTitle(response);
                        life.render(title, data);
                    });
                });
            },
            loadConfig: function (fn) {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "config.json", true);
                xhr.onload = function () {
                    if (xhr.status == 200) {
                        fn(JSON.parse(xhr.responseText));
                    } else {
                        fn({});
                    }
                };
                xhr.onerror = xhr.onabort = function () {
                    fn({});
                };
                xhr.send();
            },
            injectStylesheet: function (url) {
                var link = document.createElement("link");
                link.rel = "stylesheet";
                link.href = url;
                document.body.appendChild(link);
            },
            fetch: function (fn) {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "centuries.md", true);
                xhr.onload = function () {
                    if (xhr.status == 200) fn(xhr.responseText);
                };
                xhr.send();
            },
            parse: function (response) {
                var list = response.match(/\-\s+[^\n\r]+/gi);
                var data = [];
                if (!list) return data;
                
                list.forEach(function (l) {
                    // More flexible regex to handle various date formats including BC/AD
                    var matches = l.match(/\-\s+(.+?)\s+\*\*(.+?)\*\*\s+(.*)/i);
                    if (matches) {
                        var time = matches[1].trim();
                        var person = matches[2];
                        var description = matches[3];
                        var text = '**' + person + '** ' + description;
                        
                        data.push({
                            time: life.parseTime(time),
                            text: text,
                        });
                    } else {
                        // Fallback for lines that don't follow the **person** format
                        var fallbackMatches = l.match(/\-\s+(.+)/i);
                        if (fallbackMatches) {
                            // Try to extract date from beginning
                            var content = fallbackMatches[1];
                            var dateMatch = content.match(/^([\d\s\-\/\~BC\sAD]+)\s+(.+)/);
                            if (dateMatch) {
                                data.push({
                                    time: life.parseTime(dateMatch[1].trim()),
                                    text: dateMatch[2],
                                });
                            }
                        }
                    }
                });
                return data;
            },
            parseTitle: function (response) {
                return response.match(/[^\r\n]+/i)[0];
            },
            parseTime: function (time, point) {
                if (!point) point = "start";
                var data = {};
                
                // Handle BC dates (convert to negative numbers for calculation)
                var convertBCYear = function(yearStr) {
                    if (yearStr.includes('BC')) {
                        return -(parseInt(yearStr.replace(' BC', ''), 10));
                    }
                    return parseInt(yearStr.replace(' AD', ''), 10);
                };
                
                if (/^\~\d+( BC| AD)?$/.test(time)) {
                    // ~YYYY or ~YYYY BC/AD
                    var yearStr = time.slice(1);
                    data = {
                        startYear: convertBCYear(yearStr),
                        estimate: true,
                    };
                } else if (/^\d+( BC| AD)?$/.test(time)) {
                    // YYYY or YYYY BC/AD
                    data[point + "Year"] = convertBCYear(time);
                } else if (/^\d+\/\d+( BC| AD)?$/.test(time)) {
                    // MM/YYYY or MM/YYYY BC/AD
                    var parts = time.split("/");
                    data[point + "Month"] = parseInt(parts[0], 10);
                    data[point + "Year"] = convertBCYear(parts[1]);
                } else if (/^\d+\/\d+\/\d+( BC| AD)?$/.test(time)) {
                    // DD/MM/YYYY or DD/MM/YYYY BC/AD
                    var parts = time.split("/");
                    data[point + "Date"] = parseInt(parts[0], 10);
                    data[point + "Month"] = parseInt(parts[1], 10);
                    data[point + "Year"] = convertBCYear(parts[2]);
                } else if (/\d+.*\-/.test(time)) {
                    // TIME-TIME (handles BC/AD ranges)
                    var splitTime = time.split("-");
                    var startTime = life.parseTime(splitTime[0]);
                    var endTime = life.parseTime(splitTime[1], "end");
                    for (var k in startTime) {
                        data[k] = startTime[k];
                    }
                    for (var k in endTime) {
                        data[k] = endTime[k];
                    }
                } else if (time == "~") {
                    // NOW (for ongoing events, use 2000 AD as end)
                    data.endYear = 2000;
                    data.endMonth = 12;
                    data.endDate = 31;
                }
                data.title = time;
                return data;
            },
            firstYear: null,
            currentCentury: null,
            currentChild: null,
            currentSearch: null,
            currentCategories: [],
            selectedEvent: null,
            eventConnections: {}, // Will store event connections
            originalData: null,
            
            filterData: function(data, century, child, search, categories) {
                var filtered = data.slice(); // Copy array
                
                if (century) {
                    var centuryStart = (parseInt(century) - 1) * 100 + 1;
                    var centuryEnd = parseInt(century) * 100;
                    
                    filtered = filtered.filter(function(d) {
                        var time = d.time;
                        var startYear = time.startYear || time.year;
                        var endYear = time.endYear || startYear;
                        
                        return (startYear >= centuryStart && startYear <= centuryEnd) ||
                               (endYear >= centuryStart && endYear <= centuryEnd) ||
                               (startYear <= centuryStart && endYear >= centuryEnd);
                    });
                }
                
                if (child) {
                    filtered = filtered.filter(function(d) {
                        return d.text.includes('[child:' + child + ']') || 
                               d.text.includes('[family]') ||
                               (!d.text.includes('[child:') && !d.text.includes('[family]'));
                    });
                }
                
                if (search && search.trim()) {
                    var searchTerm = search.toLowerCase().trim();
                    filtered = filtered.filter(function(d) {
                        return d.text.toLowerCase().includes(searchTerm) ||
                               (d.title && d.title.toLowerCase().includes(searchTerm));
                    });
                }
                
                if (categories && categories.length > 0) {
                    filtered = filtered.filter(function(d) {
                        return categories.some(function(category) {
                            return d.text.includes('#' + category);
                        });
                    });
                }
                
                return filtered;
            },
            
            updateView: function() {
                if (!life.originalData) return;
                
                var filteredData = life.filterData(life.originalData, life.currentCentury, life.currentChild, life.currentSearch, life.currentCategories);
                var title = "Digital Book of Centuries";
                
                if (life.currentCentury) {
                    title += " - Century " + life.currentCentury;
                }
                if (life.currentChild) {
                    title += " (" + life.currentChild.charAt(0).toUpperCase() + life.currentChild.slice(1) + "'s Book)";
                }
                if (life.currentSearch && life.currentSearch.trim()) {
                    title += " - Search: \"" + life.currentSearch + "\"";
                }
                if (life.currentCategories && life.currentCategories.length > 0) {
                    title += " - Categories: " + life.currentCategories.join(", ");
                }
                
                life.render(title, filteredData);
            },
            
            findRelatedEvents: function(selectedEvent, allData) {
                var related = [];
                var selectedText = selectedEvent.text.toLowerCase();
                var selectedCategories = selectedText.match(/#(\w+)/g) || [];
                
                allData.forEach(function(event) {
                    if (event === selectedEvent) return;
                    
                    var eventText = event.text.toLowerCase();
                    var eventCategories = eventText.match(/#(\w+)/g) || [];
                    
                    // Find common categories
                    var commonCategories = selectedCategories.filter(function(cat) {
                        return eventCategories.includes(cat);
                    });
                    
                    // Find common keywords (rulers, places, concepts)
                    var keywords = selectedText.match(/\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\b/g) || [];
                    var commonKeywords = keywords.filter(function(keyword) {
                        return eventText.includes(keyword.toLowerCase()) && keyword.length > 3;
                    });
                    
                    // Score the relationship
                    var score = commonCategories.length * 2 + commonKeywords.length;
                    
                    if (score > 0) {
                        related.push({
                            event: event,
                            score: score,
                            commonCategories: commonCategories,
                            commonKeywords: commonKeywords
                        });
                    }
                });
                
                // Sort by relevance score
                related.sort(function(a, b) { return b.score - a.score; });
                return related.slice(0, 10); // Return top 10 related events
            },
            
            selectEvent: function(event) {
                life.selectedEvent = event;
                life.updateView();
            },
            
            exportToJSON: function() {
                var exportData = {
                    metadata: {
                        title: "Digital Book of Centuries",
                        exportDate: new Date().toISOString(),
                        totalEvents: life.originalData ? life.originalData.length : 0,
                        timeRange: life.config.timeRange
                    },
                    events: life.originalData || [],
                    config: life.config
                };
                
                var dataStr = JSON.stringify(exportData, null, 2);
                var blob = new Blob([dataStr], {type: "application/json"});
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = 'book-of-centuries-' + new Date().toISOString().split('T')[0] + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },
            
            exportToCSV: function() {
                if (!life.originalData || life.originalData.length === 0) {
                    alert('No data to export');
                    return;
                }
                
                var headers = ['Year', 'Title', 'Description', 'Categories', 'Children', 'Duration'];
                var rows = [headers];
                
                life.originalData.forEach(function(event) {
                    var year = event.time.startYear || event.time.year || '';
                    var endYear = event.time.endYear;
                    var yearStr = endYear && endYear !== year ? year + '-' + endYear : year;
                    
                    var title = event.time.title || '';
                    var text = event.text || '';
                    
                    // Extract categories
                    var categories = (text.match(/#(\w+)/g) || []).join(', ');
                    
                    // Extract children assignments
                    var children = '';
                    if (text.includes('[family]')) children = 'family';
                    else {
                        var childMatches = text.match(/\[child:(\w+)\]/g);
                        if (childMatches) {
                            children = childMatches.map(function(m) { 
                                return m.replace('[child:', '').replace(']', ''); 
                            }).join(', ');
                        }
                    }
                    
                    var duration = '';
                    if (event.time.startYear && event.time.endYear) {
                        duration = (event.time.endYear - event.time.startYear + 1) + ' years';
                    }
                    
                    // Clean text for CSV (remove markdown and tags)
                    var cleanText = text.replace(/#\w+/g, '').replace(/\[child:\w+\]/g, '').replace(/\[family\]/g, '').trim();
                    
                    rows.push([yearStr, title, cleanText, categories, children, duration]);
                });
                
                var csvContent = rows.map(function(row) {
                    return row.map(function(field) {
                        // Escape quotes and wrap in quotes if contains comma or quote
                        var escaped = (field || '').toString().replace(/"/g, '""');
                        return escaped.includes(',') || escaped.includes('"') || escaped.includes('\n') ? 
                               '"' + escaped + '"' : escaped;
                    }).join(',');
                }).join('\n');
                
                var blob = new Blob([csvContent], {type: "text/csv"});
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = 'book-of-centuries-' + new Date().toISOString().split('T')[0] + '.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },
            renderEvent: function (d) {
                var firstYear = life.firstYear;
                var yearLength = life.config.yearLength;
                var decadeLength = yearLength; // Same width as a year used to be, but now represents a decade

                var time = d.time;
                var estimate = time.estimate;
                var startYear = time.startYear;
                var startMonth = time.startMonth;
                var startDate = time.startDate;
                var endYear = time.endYear;
                var endMonth = time.endMonth;
                var endDate = time.endDate;
                var width = 0;

                // Calculate offset based on decades (compressed scale)
                var firstDecade = Math.floor(firstYear / 10) * 10;
                var eventDecade = Math.floor(startYear / 10) * 10;
                var decadeOffset = (eventDecade - firstDecade) / 10 * decadeLength;
                
                // Position within the decade (0-9 years compressed into the decade column)
                var yearWithinDecade = startYear - eventDecade;
                var yearOffset = yearWithinDecade * (decadeLength / 10); // Compress 10 years into one column width
                
                // Add month/day precision within the year (even more compressed)
                var monthOffset = 0;
                var dayOffset = 0;
                if (startMonth) {
                    monthOffset = (startMonth - 1) * (decadeLength / 10 / 12);
                }
                if (startDate) {
                    dayOffset = (startDate - 1) * (decadeLength / 10 / 12 / 30);
                }
                
                var offset = decadeOffset + yearOffset + monthOffset + dayOffset;

                // Calculate width (also compressed)
                if (endYear) {
                    var endDecade = Math.floor(endYear / 10) * 10;
                    var endYearWithinDecade = endYear - endDecade;
                    var endDecadeOffset = (endDecade - firstDecade) / 10 * decadeLength;
                    var endYearOffset = endYearWithinDecade * (decadeLength / 10);
                    
                    var endMonthOffset = 0;
                    var endDayOffset = 0;
                    if (endMonth) {
                        endMonthOffset = (endMonth - 1) * (decadeLength / 10 / 12);
                    }
                    if (endDate) {
                        endDayOffset = (endDate - 1) * (decadeLength / 10 / 12 / 30);
                    }
                    
                    var endOffset = endDecadeOffset + endYearOffset + endMonthOffset + endDayOffset;
                    width = endOffset - offset;
                } else {
                    if (startDate) {
                        width = decadeLength / 10 / 365; // Day width (compressed)
                    } else if (startMonth) {
                        width = decadeLength / 10 / 12; // Month width (compressed)
                    } else {
                        width = decadeLength / 10; // Year width (compressed - 1/10th of decade column)
                    }
                }

                // Parse Markdown links in the text
                // credit: http://stackoverflow.com/a/9268827
                var link = null;
                while (
                    (link = d.text.match(
                        /\[([^\]]+)\]\(([^)"]+)(?: \"([^\"]+)\")?\)/,
                    ))
                ) {
                    var link_attr = "";
                    if (link[3] !== undefined) {
                        link_attr = " title='" + link[3] + "'";
                    }
                    d.text = d.text.replace(
                        link[0],
                        "<a href='" +
                            link[2] +
                            "'" +
                            link_attr +
                            ">" +
                            link[1] +
                            "</a>",
                    );
                }

                // Parse hashtags in the text
                d.text = d.text.replace(
                    /\s#([^\s]+)/g,
                    "<code class='$1'> #$1</code>",
                );

                // Parse Bold in the text
                d.text = d.text.replace(
                    /\*\*([^\*]+)\*\*/g,
                    "<strong>$1</strong>",
                );

                // Parse Italic in the text
                d.text = d.text.replace(/\s\_([^\*]+)\_/g, " <i>$1</i>");
                
                // Determine event classes for highlighting
                var eventClasses = "event";
                var eventId = "event-" + startYear + "-" + d.text.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                
                if (life.selectedEvent && life.selectedEvent === d) {
                    eventClasses += " selected-event";
                } else if (life.selectedEvent) {
                    var relatedEvents = life.findRelatedEvents(life.selectedEvent, life.originalData || []);
                    var isRelated = relatedEvents.some(function(rel) { return rel.event === d; });
                    if (isRelated) {
                        eventClasses += " related-event";
                    }
                }

                return (
                    '<div class="' + eventClasses + '" id="' + eventId + '" data-event-index="' + d.originalIndex + '" style="margin-left: ' +
                    offset.toFixed(2) +
                    'px">' +
                    '<div class="time" style="width: ' +
                    width.toFixed(2) +
                    'px"></div>' +
                    "<b>" +
                    d.time.title +
                    "</b> " +
                    d.text +
                    "</div>"
                );
            },
            renderYears: function (firstYear, lastYear) {
                var decadeLength = life.config.yearLength; // Same width as before, but for decades
                var html = "";
                var hideAge = life.config.hideAge;
                
                // Round to nearest decades
                var firstDecade = Math.floor(firstYear / 10) * 10;
                var lastDecade = Math.floor(lastYear / 10) * 10;
                
                for (var decade = firstDecade; decade <= lastDecade; decade += 10) {
                    var decadeEnd = decade + 9;
                    var decadeDisplay = decade;
                    
                    // Handle BC/AD display for decades
                    if (decade <= 0 && decadeEnd <= 0) {
                        decadeDisplay = Math.abs(decadeEnd) + "-" + Math.abs(decade) + " BC";
                    } else if (decade <= 0 && decadeEnd > 0) {
                        decadeDisplay = Math.abs(decade) + " BC - " + decadeEnd + " AD";
                    } else if (decade <= 100) {
                        decadeDisplay = decade + "-" + decadeEnd + " AD";
                    } else {
                        decadeDisplay = decade + "-" + decadeEnd;
                    }
                    
                    html +=
                        '<div class="year decade" style="width: ' +
                        decadeLength.toFixed(2) +
                        'px"><span>' +
                        decadeDisplay +
                        "</span></div>";
                }
                return html;
            },
            render: function (title, data) {
                // Store original data on first render
                if (!life.originalData) {
                    life.originalData = data;
                    life.initControls();
                    life.setupEventListeners(); // Setup event delegation
                }
                
                document.title = title;
                life.$title.innerHTML = title;

                // Use configured time range for historical timeline, but adjust for filtered data
                var firstYear = life.config.timeRange ? life.config.timeRange.start : 1;
                var lastYear = life.config.timeRange ? life.config.timeRange.end : 2000;
                
                // If viewing a specific century, adjust the range
                if (life.currentCentury) {
                    firstYear = (parseInt(life.currentCentury) - 1) * 100 + 1;
                    lastYear = parseInt(life.currentCentury) * 100;
                }
                
                // Override with actual data range if it extends beyond configured range
                data.forEach(function (d) {
                    var time = d.time;
                    var startYear = time.startYear;
                    var endYear = time.endYear;
                    if (startYear && startYear < firstYear)
                        firstYear = startYear;
                    if (endYear && endYear > lastYear) lastYear = endYear;
                });
                life.firstYear = firstYear;

                var html = '<div id="life-events">';
                // 'comment_' class name is to hide it from Safari Reader
                html +=
                    '<div id="life-years" class="comment_">' +
                    life.renderYears(firstYear, lastYear) +
                    "</div>";
                data.forEach(function (d, index) {
                    d.originalIndex = index; // Add index for event identification
                    html += life.renderEvent(d);
                });
                html += "</div>";
                life.$el.innerHTML = html;
            },
            
            setupEventListeners: function() {
                // Add event delegation for event clicks (only once)
                if (!life.eventListenerAdded) {
                    life.$el.addEventListener('click', function(e) {
                        var eventElement = e.target.closest('.event');
                        if (eventElement && eventElement.dataset.eventIndex !== undefined) {
                            var eventIndex = parseInt(eventElement.dataset.eventIndex);
                            var clickedEvent = life.originalData[eventIndex];
                            if (clickedEvent) {
                                if (life.selectedEvent === clickedEvent) {
                                    // Deselect if clicking the same event
                                    life.selectedEvent = null;
                                } else {
                                    life.selectEvent(clickedEvent);
                                }
                            }
                        }
                    });
                    life.eventListenerAdded = true;
                }
            },
            
            initControls: function() {
                var centurySelector = document.getElementById('century-selector');
                var childSelector = document.getElementById('child-selector');
                var searchInput = document.getElementById('search-input');
                var categorySelector = document.getElementById('category-selector');
                var clearFiltersBtn = document.getElementById('clear-filters-btn');
                var exportJsonBtn = document.getElementById('export-json-btn');
                var exportCsvBtn = document.getElementById('export-csv-btn');
                
                centurySelector.addEventListener('change', function() {
                    life.currentCentury = this.value || null;
                    life.updateView();
                });
                
                childSelector.addEventListener('change', function() {
                    life.currentChild = this.value || null;
                    life.updateView();
                });
                
                searchInput.addEventListener('input', function() {
                    life.currentSearch = this.value || null;
                    life.updateView();
                });
                
                categorySelector.addEventListener('change', function() {
                    var selectedCategories = Array.from(this.selectedOptions)
                        .map(function(option) { return option.value; })
                        .filter(function(value) { return value !== ""; });
                    life.currentCategories = selectedCategories;
                    life.updateView();
                });
                
                clearFiltersBtn.addEventListener('click', function() {
                    life.currentCentury = null;
                    life.currentChild = null;
                    life.currentSearch = null;
                    life.currentCategories = [];
                    
                    centurySelector.value = "";
                    childSelector.value = "";
                    searchInput.value = "";
                    categorySelector.selectedIndex = -1;
                    
                    life.updateView();
                });
                
                exportJsonBtn.addEventListener('click', function() {
                    life.exportToJSON();
                });
                
                exportCsvBtn.addEventListener('click', function() {
                    life.exportToCSV();
                });
            },
            
            preparePrint: function() {
                // Add print header without changing the timeline layout
                var centuryText = life.currentCentury ? 
                    " - Century " + life.currentCentury + " (" + 
                    ((parseInt(life.currentCentury) - 1) * 100 + 1) + "-" + 
                    (parseInt(life.currentCentury) * 100) + " AD)" : 
                    " (1-2000 AD)";
                    
                var childText = life.currentChild ? 
                    " - " + life.currentChild.charAt(0).toUpperCase() + life.currentChild.slice(1) + "'s Book" : 
                    "";
                
                // Add print header to the existing timeline
                var printHeader = '<div class="print-only century-header">';
                printHeader += '<h1>Digital Book of Centuries</h1>';
                printHeader += '<h2>' + centuryText + childText + '</h2>';
                printHeader += '</div>';
                
                // Insert header at the beginning without replacing timeline
                life.$el.insertAdjacentHTML('afterbegin', printHeader);
                
                // Trigger print dialog
                setTimeout(function() {
                    window.print();
                    // Remove the print header after printing
                    var printHeaders = document.querySelectorAll('.print-only.century-header');
                    printHeaders.forEach(function(header) {
                        if (header.parentNode) {
                            header.parentNode.removeChild(header);
                        }
                    });
                }, 500);
            },
        };

        var slider = {
            startingMousePostition: {},
            containerOffset: {},
            init: function () {
                window.addEventListener("mousedown", function (event) {
                    slider.startingMousePostition = {
                        x: event.clientX,
                        y: event.clientY,
                    };
                    slider.containerOffset = {
                        x: life.$el.scrollLeft,
                        y: life.$el.scrollTop,
                    };
                    window.addEventListener("mousemove", slider.slide);
                });
                window.addEventListener("mouseup", function (event) {
                    window.removeEventListener("mousemove", slider.slide);
                });
            },
            slide: function (event) {
                event.preventDefault();
                var x =
                    slider.containerOffset.x +
                    (slider.startingMousePostition.x - event.clientX);
                var y =
                    slider.containerOffset.y +
                    (slider.startingMousePostition.y - event.clientY);
                life.$el.scrollLeft = x;
                life.$el.scrollTop = y;
            },
        };

        life.start();
        slider.init();
        
        // Make print function available globally
        window.preparePrint = function() {
            life.preparePrint();
        };
    })();
</script>
